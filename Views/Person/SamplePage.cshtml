@{
    ViewData["Title"] = "الشجرة العائلية المتقدمة";
    var familyTreeId = ViewBag.FamilyTreeId;
    var familyTreeName = ViewBag.FamilyTreeName ?? "شجرة عائلية";
    var personsCount = ViewBag.PersonsCount ?? 0;
    var personsJson = ViewBag.PersonsJson ?? "[]";
}

@if (personsCount == 0)
{
    <div class="container-fluid mt-4" dir="rtl">
        <div class="alert alert-info text-center">
            <h4>ℹ️ لا توجد بيانات</h4>
            <p>لم يتم إضافة أي أفراد إلى هذه الشجرة العائلية بعد.</p>
            <a href="@Url.Action("Create", "Person", new { familyTreeId = familyTreeId })" class="btn btn-primary">
                <i class="fas fa-plus"></i> إضافة أول فرد
            </a>
        </div>
    </div>
    return;
}

<div class="container-fluid mt-4" dir="rtl">
    <h2 class="text-center mb-4">@familyTreeName - الشجرة العائلية</h2>

    <div class="d-flex justify-content-center mb-3">
        <button id="printPdf" class="btn btn-success btn-lg">
            <i class="fas fa-file-pdf me-2"></i> طباعة PDF
        </button>
    </div>

    <div id="tree-container" style="width: 100%; height: 700px; border: 1px solid #ddd; border-radius: 10px; background: #f8f9fa; overflow: auto; position: relative;">
        <div id="family-tree" style="position: relative;">
            <!-- سيتم رسم الشجرة هنا بالJavaScript -->
        </div>
        <svg id="connections-svg" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1;"></svg>
    </div>

    <!-- معلومات عند التمرير -->
    <div id="node-info" class="card mt-3" style="display: none;">
        <div class="card-body">
            <h5 id="info-name"></h5>
            <p id="info-details" class="mb-0"></p>
        </div>
    </div>
</div>

<style>
    .tree-node {
        position: absolute;
        min-width: 180px;
        max-width: 250px;
        padding: 12px;
        border-radius: 10px;
        box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        z-index: 10;
        background: white;
        word-wrap: break-word;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

        .tree-node.male {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            border: 2px solid #1976d2;
        }

        .tree-node.female {
            background: linear-gradient(135deg, #fce4ec, #f8bbd9);
            border: 2px solid #c2185b;
        }

        .tree-node:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            z-index: 100;
        }

    .node-name {
        font-weight: bold;
        font-size: 14px;
        margin-bottom: 5px;
        line-height: 1.3;
    }

    .node-details {
        font-size: 11px;
        line-height: 1.3;
    }

    .connection-line {
        stroke: #666;
        stroke-width: 2;
        fill: none;
    }

        .connection-line.male {
            stroke: #1976d2;
        }

        .connection-line.female {
            stroke: #c2185b;
        }

    .pyramid-container {
        position: relative;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        padding: 20px;
    }

    .generation-label {
        position: absolute;
        left: 10px;
        background: rgba(0,0,0,0.1);
        padding: 5px 10px;
        border-radius: 5px;
        font-size: 12px;
        font-weight: bold;
    }

    #tree-container {
        cursor: grab;
    }

        #tree-container:active {
            cursor: grabbing;
        }

    .loading-spinner {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
    }

    .pdf-loading {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
        z-index: 9999;
        display: none;
        justify-content: center;
        align-items: center;
        color: white;
        font-size: 18px;
    }

    .alert-notification {
        position: fixed !important;
        top: 20px !important;
        right: 20px !important;
        z-index: 9999 !important;
        min-width: 300px !important;
    }
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

@section Scripts {
    <script>
        // بيانات الشجرة من قاعدة البيانات
        const personsJson = '@Html.Raw(personsJson)';
        const familyTreeId = @familyTreeId;
        const familyTreeName = '@familyTreeName';
        const personsCount = @personsCount;

        let treeData = [];
        let panning = false;
        let startX, startY, scrollLeft, scrollTop;

        // دالة تحميل البيانات الحقيقية
        function loadRealData() {
            try {
                if (personsJson && personsJson !== '[]') {
                    treeData = JSON.parse(personsJson);
                    console.log('تم تحميل البيانات الحقيقية:', treeData.length, 'فرد');
                    return true;
                }
                return false;
            } catch (e) {
                console.error('خطأ في تحميل البيانات:', e);
                return false;
            }
        }

        function initializeSVG() {
            const svg = $('#connections-svg');
            svg.empty();

            const defs = $(`
                <defs>
                    <marker id="arrowhead-male" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                        <polygon points="0 0, 10 3.5, 0 7" fill="#1976d2"/>
                    </marker>
                    <marker id="arrowhead-female" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                        <polygon points="0 0, 10 3.5, 0 7" fill="#c2185b"/>
                    </marker>
                </defs>
            `);
            svg.append(defs);
        }

        function organizeByGenerations(persons) {
            const generations = [];
            const firstGen = persons.filter(person => !person.fatherId);
            generations.push(firstGen);

            let currentGen = firstGen;
            while (currentGen.length > 0) {
                const nextGen = [];
                currentGen.forEach(person => {
                    const children = persons.filter(p => p.fatherId === person.id);
                    nextGen.push(...children);
                });

                if (nextGen.length > 0) {
                    generations.push(nextGen);
                }
                currentGen = nextGen;
            }
            return generations;
        }

        function drawConnections() {
            const svg = $('#connections-svg');
            svg.find('path').remove();

            treeData.forEach(person => {
                if (person.fatherId) {
                    const father = treeData.find(p => p.id === person.fatherId);
                    if (father) {
                        drawConnection(father, person);
                    }
                }
            });
        }

        function drawConnection(fromPerson, toPerson) {
            const fromElement = $(`[data-person-id="${fromPerson.id}"]`);
            const toElement = $(`[data-person-id="${toPerson.id}"]`);

            if (fromElement.length === 0 || toElement.length === 0) return;

            const fromRect = fromElement[0].getBoundingClientRect();
            const toRect = toElement[0].getBoundingClientRect();
            const container = $('#family-tree')[0].getBoundingClientRect();

            const fromX = fromRect.left - container.left + fromRect.width / 2;
            const fromY = fromRect.bottom - container.top;
            const toX = toRect.left - container.left + toRect.width / 2;
            const toY = toRect.top - container.top;

            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            const gender = toPerson.gender || 'Male';
            const arrowhead = gender === 'Male' ? 'url(#arrowhead-male)' : 'url(#arrowhead-female)';

            const controlY = fromY + (toY - fromY) / 2;
            const pathData = `
                M ${fromX} ${fromY}
                C ${fromX} ${controlY}, ${toX} ${controlY}, ${toX} ${toY}
            `;

            path.setAttribute('d', pathData);
            path.setAttribute('class', `connection-line ${gender}`);
            path.setAttribute('marker-end', arrowhead);

            $('#connections-svg').append(path);
        }

        function drawPyramidTree() {
            const container = $('#family-tree');
            container.empty();

            if (treeData.length === 0) {
                container.html('<div class="alert alert-warning text-center">لا توجد بيانات لعرضها</div>');
                return;
            }

            const generations = organizeByGenerations(treeData);
            const containerWidth = 2000;
            const startY = 50;
            const verticalSpacing = 150;

            generations.forEach((generation, genIndex) => {
                const generationY = startY + (genIndex * verticalSpacing);
                const generationSize = generation.length;

                const horizontalSpacing = Math.min(300, (containerWidth - 200) / Math.max(1, generationSize));
                const totalWidth = generationSize * horizontalSpacing;
                const startX = (containerWidth - totalWidth) / 2;

                container.append(`
                    <div class="generation-label" style="top: ${generationY - 30}px;">
                        الجيل ${genIndex + 1}
                    </div>
                `);

                generation.forEach((person, personIndex) => {
                    const personX = startX + (personIndex * horizontalSpacing);
                    createPersonNode(person, personX, generationY, container);
                });
            });

            setTimeout(drawConnections, 200);
        }

        function createPersonNode(person, x, y, container) {
            const birthDate = formatDate(person.birthDate);
            const city = person.city || '';
            const occupationName = person.occupationName || '';
            const gender = person.gender || 'Male';

            const nodeContent = `
                <div class="tree-node ${gender === 'Male' ? 'male' : 'female'}"
                     data-person-id="${person.id}"
                     style="left: ${x}px; top: ${y}px;">
                    <div class="node-name">${escapeHtml(person.fullName || 'غير معروف')}</div>
                    <div class="node-details">
                        ${birthDate ? '📅 ' + birthDate + '<br>' : ''}
                        ${city ? '🏠 ' + escapeHtml(city) + '<br>' : ''}
                        ${occupationName ? '💼 ' + escapeHtml(occupationName) : ''}
                    </div>
                </div>
            `;

            const node = $(nodeContent);
            node.on('click', function(e) {
                e.stopPropagation();
                showPersonDetails(person);
            });

            container.append(node);
        }

        function formatDate(dateString) {
            try {
                if (!dateString) return '';
                const date = new Date(dateString);
                return isNaN(date.getTime()) ? dateString : date.toLocaleDateString('ar-EG');
            } catch (e) {
                return dateString;
            }
        }

        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe
                .toString()
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function showPersonDetails(person) {
            const birthDate = formatDate(person.birthDate);
            const city = person.city || '';
            const occupationName = person.occupationName || '';

            let details = '';
            if (birthDate) details += `الميلاد: ${birthDate}<br>`;
            if (city) details += `المدينة: ${escapeHtml(city)}<br>`;
            if (occupationName) details += `المهنة: ${escapeHtml(occupationName)}<br>`;
            if (!details) details = 'لا توجد معلومات إضافية';

            const infoContent = `
                <div class="card-body">
                    <h5>${escapeHtml(person.fullName || 'غير معروف')}</h5>
                    <p>${details}</p>
                    <div class="mt-2">
                        <a href="/Person/Details/${person.id}" class="btn btn-info btn-sm">
                            <i class="fas fa-eye"></i> تفاصيل
                        </a>
                        <a href="/Person/Edit/${person.id}" class="btn btn-warning btn-sm">
                            <i class="fas fa-edit"></i> تعديل
                        </a>
                        <a href="/Person/Create?familyTreeId=${familyTreeId}&fatherId=${person.id}" class="btn btn-success btn-sm">
                            <i class="fas fa-plus"></i> إضافة ابن
                        </a>
                    </div>
                </div>
            `;

            $('#node-info').html(infoContent).show();
        }

        function printToPdf() {
            showPdfLoading(true);

            setTimeout(() => {
                try {
                    const originalTree = $('#family-tree').clone();
                    const originalSVG = $('#connections-svg').clone();

                    const printContainer = $('<div style="background: white; position: absolute; left: 0; top: 0; z-index: 99999; width: 100%;"></div>');

                    const title = $(`
                        <div style="text-align: center; padding: 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; margin-bottom: 20px;">
                            <h1 style="margin: 0; font-size: 32px; font-weight: bold;">الشجرة العائلية</h1>
                            <h2 style="margin: 10px 0; font-size: 24px;">${familyTreeName}</h2>
                            <div style="display: flex; justify-content: center; gap: 20px; margin-top: 15px; font-size: 14px;">
                                <span>📅 تم الإنشاء في: ${new Date().toLocaleDateString('ar-EG')}</span>
                                <span>👥 عدد الأفراد: ${personsCount}</span>
                            </div>
                        </div>
                    `);
                    printContainer.append(title);
                    printContainer.append(originalTree);
                    printContainer.append(originalSVG);

                    const tempContainer = $('<div style="position: fixed; left: 0; top: 0; width: 100%; height: 100%; background: white; z-index: 99998; overflow: auto;"></div>');
                    tempContainer.append(printContainer);
                    $('body').append(tempContainer);

                    const options = {
                        scale: 2,
                        useCORS: true,
                        backgroundColor: '#ffffff',
                        logging: false,
                        width: printContainer[0].scrollWidth,
                        height: printContainer[0].scrollHeight
                    };

                    html2canvas(printContainer[0], options).then(canvas => {
                        tempContainer.remove();

                        const imgData = canvas.toDataURL('image/png', 1.0);
                        const pdf = new jspdf.jsPDF({
                            orientation: canvas.width > canvas.height ? 'landscape' : 'portrait',
                            unit: 'mm',
                            format: 'a4'
                        });

                        const pdfWidth = pdf.internal.pageSize.getWidth();
                        const pdfHeight = pdf.internal.pageSize.getHeight();
                        const imgWidth = canvas.width;
                        const imgHeight = canvas.height;

                        const ratio = Math.min(pdfWidth / imgWidth, pdfHeight / imgHeight) * 0.95;
                        const finalWidth = imgWidth * ratio;
                        const finalHeight = imgHeight * ratio;

                        pdf.addImage(imgData, 'PNG',
                            (pdfWidth - finalWidth) / 2,
                            (pdfHeight - finalHeight) / 2,
                            finalWidth,
                            finalHeight
                        );

                        pdf.setFontSize(10);
                        pdf.setTextColor(100);
                        pdf.text(`تم الإنشاء في: ${new Date().toLocaleDateString('ar-EG')}`, 10, pdfHeight - 10);

                        const fileName = `شجرة_عائلية_${familyTreeName.replace(/\s+/g, '_')}.pdf`;
                        pdf.save(fileName);

                        showPdfLoading(false);
                        showNotification('تم إنشاء PDF بنجاح', 'success');

                    }).catch(error => {
                        console.error('خطأ في إنشاء PDF:', error);
                        tempContainer.remove();
                        showPdfLoading(false);
                        showNotification('حدث خطأ في إنشاء PDF', 'danger');
                    });

                } catch (error) {
                    console.error('خطأ عام:', error);
                    showPdfLoading(false);
                    showNotification('حدث خطأ غير متوقع', 'danger');
                }
            }, 1000);
        }

        function showPdfLoading(show) {
            let loadingDiv = $('#pdf-loading');
            if (show) {
                if (loadingDiv.length === 0) {
                    loadingDiv = $(`
                        <div id="pdf-loading" class="pdf-loading">
                            <div class="text-center">
                                <div class="spinner-border text-light mb-3" role="status">
                                    <span class="sr-only">جاري التحميل...</span>
                                </div>
                                <div>جاري إنشاء PDF...</div>
                            </div>
                        </div>
                    `);
                    $('body').append(loadingDiv);
                }
                loadingDiv.show();
            } else {
                loadingDiv.hide();
            }
        }

        function showNotification(message, type = 'info') {
            $('.alert-notification').remove();

            const alertClass = {
                'info': 'alert-info',
                'success': 'alert-success',
                'danger': 'alert-danger',
                'warning': 'alert-warning'
            }[type] || 'alert-info';

            const icon = {
                'info': 'fa-info-circle',
                'success': 'fa-check-circle',
                'danger': 'fa-exclamation-circle',
                'warning': 'fa-exclamation-triangle'
            }[type];

            const notification = $(`
                <div class="alert ${alertClass} alert-dismissible fade show position-fixed alert-notification">
                    <div class="d-flex align-items-center">
                        <i class="fas ${icon} me-2"></i>
                        <div>${message}</div>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `);

            $('body').append(notification);
            setTimeout(() => {
                notification.alert('close');
            }, 3000);
        }

        function initializeTree() {
            const container = $('#family-tree');
            container.empty().html(`
                <div class="loading-spinner">
                    <div class="spinner-border text-primary" role="status">
                        <span class="sr-only">جاري التحميل...</span>
                    </div>
                    <p class="mt-2">جاري تحميل الشجرة العائلية...</p>
                </div>
            `);

            setTimeout(() => {
                if (treeData.length > 0) {
                    container.addClass('pyramid-container');
                    initializeSVG();
                    drawPyramidTree();
                    $('.loading-spinner').remove();
                }
            }, 100);
        }

        function setupPan() {
            const container = $('#tree-container');

            container.on('mousedown', function(e) {
                if ($(e.target).closest('.tree-node').length === 0) {
                    panning = true;
                    startX = e.pageX - container.offset().left;
                    startY = e.pageY - container.offset().top;
                    scrollLeft = container.scrollLeft();
                    scrollTop = container.scrollTop();
                    container.css('cursor', 'grabbing');
                }
            });

            $(document).on('mouseup', function() {
                panning = false;
                container.css('cursor', 'grab');
            });

            container.on('mousemove', function(e) {
                if (!panning) return;
                e.preventDefault();
                const x = e.pageX - container.offset().left;
                const y = e.pageY - container.offset().top;
                const walkX = (x - startX) * 2;
                const walkY = (y - startY) * 2;
                container.scrollLeft(scrollLeft - walkX);
                container.scrollTop(scrollTop - walkY);
            });

            $('#printPdf').on('click', printToPdf);
        }

        $(document).ready(function () {
            console.log('بدء تحميل البيانات الحقيقية...');

            if (loadRealData()) {
                initializeTree();
                setupPan();
            } else {
                $('#family-tree').html(`
                    <div class="alert alert-danger text-center" style="margin: 50px;">
                        <h4>❌ خطأ في تحميل البيانات</h4>
                        <p>حدث خطأ أثناء تحميل بيانات الشجرة العائلية.</p>
                        <button onclick="location.reload()" class="btn btn-primary">
                            <i class="fas fa-redo"></i> إعادة تحميل
                        </button>
                    </div>
                `);
            }

            $(document).on('click', function(e) {
                if (!$(e.target).closest('#node-info, .tree-node').length) {
                    $('#node-info').hide();
                }
            });
        });
    </script>
}