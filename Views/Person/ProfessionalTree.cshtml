@{
    ViewData["Title"] = "الشجرة العائلية المتقدمة";
    var familyTreeId = ViewBag.FamilyTreeId;
    var familyTreeName = ViewBag.FamilyTreeName ?? "شجرة عائلية";
    var personsCount = ViewBag.PersonsCount ?? 0;
}

@if (personsCount == 0)
{
    <div class="container-fluid mt-4" dir="rtl">
        <div class="alert alert-info text-center">
            <h4>ℹ️ لا توجد بيانات</h4>
            <p>لم يتم إضافة أي أفراد إلى هذه الشجرة العائلية بعد.</p>
            <a href="@Url.Action("Create", "Person", new { familyTreeId = familyTreeId })" class="btn btn-primary">
                <i class="fas fa-plus"></i> إضافة أول فرد
            </a>
        </div>
    </div>
    return;
}

<div class="container-fluid mt-4" dir="rtl">
    <h2 class="text-center mb-4">@familyTreeName - الشجرة العائلية المتقدمة</h2>

    <div class="d-flex justify-content-between mb-3">
        <div>
            <a href="@Url.Action("Index", "Person", new { familyTreeId = familyTreeId })" class="btn btn-secondary no-print">
                <i class="fas fa-list"></i> العرض العادي
            </a>
            <a href="@Url.Action("FamilyTreeView", "Person", new { familyTreeId = familyTreeId })" class="btn btn-info no-print">
                <i class="fas fa-project-diagram"></i> الشجرة البسيطة
            </a>
            <button id="printPdf" class="btn btn-success no-print">
                <i class="fas fa-file-pdf"></i> طباعة PDF
            </button>
        </div>
        <div class="no-print">
            <div class="btn-group me-2">
                <button type="button" class="btn btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown">
                    <i class="fas fa-palette"></i> شكل البطاقة
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item card-style" data-style="default" href="#">🔵 شكل افتراضي</a></li>
                    <li><a class="dropdown-item card-style" data-style="modern" href="#">🎨 شكل حديث</a></li>
                    <li><a class="dropdown-item card-style" data-style="elegant" href="#">✨ شكل أنيق</a></li>
                    <li><a class="dropdown-item card-style" data-style="minimal" href="#">⚪ شكل بسيط</a></li>
                    <li><a class="dropdown-item card-style" data-style="colorful" href="#">🌈 شكل ملون</a></li>
                </ul>
            </div>

            <div class="btn-group me-2">
                <button type="button" class="btn btn-outline-success dropdown-toggle" data-bs-toggle="dropdown">
                    <i class="fas fa-project-diagram"></i> شكل العرض
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item layout-style" data-layout="hierarchical" href="#">🌳 شكل هرمي</a></li>
                    <li><a class="dropdown-item layout-style" data-layout="leaf" href="#">🍃 شكل ورقة شجرة</a></li>
                    <li><a class="dropdown-item layout-style" data-layout="simple" href="#">📊 شكل مبسط</a></li>
                </ul>
            </div>

            <button id="zoomIn" class="btn btn-outline-primary">
                <i class="fas fa-search-plus"></i> تكبير
            </button>
            <button id="zoomOut" class="btn btn-outline-primary">
                <i class="fas fa-search-minus"></i> تصغير
            </button>
            <button id="resetView" class="btn btn-outline-secondary">
                <i class="fas fa-sync"></i> إعادة تعيين
            </button>
        </div>
    </div>

    <div id="tree-container" style="width: 100%; height: 700px; border: 1px solid #ddd; border-radius: 10px; background: #f8f9fa; overflow: auto; position: relative;">
        <div id="family-tree" style="position: relative;">
            <!-- سيتم رسم الشجرة هنا بالJavaScript -->
        </div>
        <!-- SVG للخطوط - إضافة من الكود الثاني -->
        <svg id="connections-svg" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1;"></svg>
    </div>

    <!-- معلومات عند التمرير -->
    <div id="node-info" class="card mt-3 no-print" style="display: none;">
        <div class="card-body">
            <h5 id="info-name"></h5>
            <p id="info-details" class="mb-0"></p>
        </div>
    </div>
</div>

<!-- ستايل متقدم للشجرة -->
<style>
    /* الأنيميشن المفقود - إصلاح مشكلة keyframes */
    @@keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @@keyframes pulse {
        0% {
            transform: scale(1);
        }

        50% {
            transform: scale(1.05);
        }

        100% {
            transform: scale(1);
        }
    }

    @@keyframes slideInRight {
        from {
            opacity: 0;
            transform: translateX(30px);
        }

        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    @@keyframes bounceIn {
        0% {
            opacity: 0;
            transform: scale(0.3);
        }

        50% {
            opacity: 1;
            transform: scale(1.05);
        }

        70% {
            transform: scale(0.9);
        }

        100% {
            opacity: 1;
            transform: scale(1);
        }
    }

    @@keyframes drawLine {
        from {
            stroke-dashoffset: 1000;
        }

        to {
            stroke-dashoffset: 0;
        }
    }

    /* الأشكال الافتراضية - هرمي */
    .tree-node {
        position: absolute;
        min-width: 180px;
        max-width: 250px;
        padding: 12px;
        border-radius: 10px;
        box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        z-index: 10;
        background: white;
        word-wrap: break-word;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        animation: fadeInUp 0.5s ease-out;
    }

        .tree-node.male {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            border: 2px solid #1976d2;
        }

        .tree-node.female {
            background: linear-gradient(135deg, #fce4ec, #f8bbd9);
            border: 2px solid #c2185b;
        }

        .tree-node.connected {
            background: linear-gradient(135deg, #e8f5e8, #c8e6c9);
            border: 2px solid #388e3c;
        }

        /* أشكال البطاقات الإضافية */
        .tree-node.modern {
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border: none;
            background: white;
            animation: slideInRight 0.5s ease-out;
        }

            .tree-node.modern.male {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
            }

            .tree-node.modern.female {
                background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
                color: white;
            }

            .tree-node.modern .node-details {
                color: rgba(255,255,255,0.9);
            }

        .tree-node.elegant {
            border-radius: 8px;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
            border: 1px solid #e0e0e0;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            animation: fadeInUp 0.6s ease-out;
        }

            .tree-node.elegant.male {
                background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
                color: white;
                border: none;
            }

            .tree-node.elegant.female {
                background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
                color: white;
                border: none;
            }

        .tree-node.minimal {
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #ddd;
            background: white;
            animation: fadeInUp 0.4s ease-out;
        }

            .tree-node.minimal.male {
                border-left: 4px solid #1976d2;
                background: #f8fbff;
            }

            .tree-node.minimal.female {
                border-left: 4px solid #c2185b;
                background: #fff8fb;
            }

        .tree-node.colorful {
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            border: none;
            color: white;
            animation: bounceIn 0.6s ease-out;
        }

            .tree-node.colorful.male {
                background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
            }

            .tree-node.colorful.female {
                background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%);
                color: #333;
            }

        /* تأثيرات مشتركة */
        .tree-node:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            z-index: 100;
            animation: pulse 1s infinite;
        }

    .node-name {
        font-weight: bold;
        font-size: 14px;
        margin-bottom: 5px;
        line-height: 1.3;
    }

    .node-details {
        font-size: 11px;
        line-height: 1.3;
    }

    /* الخطوط باستخدام SVG - من الكود الثاني */
    .connection-line {
        stroke: #666;
        stroke-width: 2;
        fill: none;
        marker-end: url(#arrowhead);
    }

        .connection-line.male {
            stroke: #1976d2;
        }

        .connection-line.female {
            stroke: #c2185b;
        }

    /* شكل ورقة الشجرة - معدل */
    .leaf-layout {
        background: linear-gradient(135deg, #e8f5e8, #c8e6c9);
        border-radius: 20px;
        padding: 30px;
        min-height: 600px;
        border: 3px solid #4CAF50;
        text-align: center;
        width: 100%;
        display: block;
    }

    .leaf-node {
        background: white;
        border-radius: 15px;
        padding: 15px;
        margin: 10px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        border: 2px solid #4CAF50;
        text-align: center;
        display: inline-block;
        min-width: 180px;
        max-width: 220px;
        transition: all 0.3s ease;
        position: relative;
        animation: fadeInUp 0.5s ease-out;
        vertical-align: top;
    }

        .leaf-node.male {
            border-color: #1976d2;
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
        }

        .leaf-node.female {
            border-color: #c2185b;
            background: linear-gradient(135deg, #fce4ec, #f8bbd9);
        }

        .leaf-node:hover {
            transform: translateY(-3px) scale(1.03);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
            animation: pulse 0.8s infinite;
        }

    .leaf-generation {
        text-align: center;
        margin: 20px 0;
        position: relative;
        padding: 15px 0;
        animation: slideInRight 0.6s ease-out;
        border-bottom: 2px dashed #4CAF50;
    }

        .leaf-generation:last-child {
            border-bottom: none;
        }

    .generation-title {
        background: #4CAF50;
        color: white;
        padding: 8px 20px;
        border-radius: 25px;
        display: inline-block;
        margin-bottom: 15px;
        font-weight: bold;
        box-shadow: 0 3px 10px rgba(76, 175, 80, 0.3);
        animation: bounceIn 0.5s ease-out;
    }

    /* شكل مبسط */
    .simple-layout {
        background: linear-gradient(135deg, #f5f5f5, #e0e0e0);
        padding: 20px;
        text-align: center;
        min-height: 600px;
    }

    .simple-node {
        background: white;
        border-radius: 8px;
        padding: 12px 15px;
        margin: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        border: 1px solid #ddd;
        display: inline-block;
        text-align: center;
        min-width: 160px;
        transition: all 0.3s ease;
        animation: fadeInUp 0.4s ease-out;
    }

        .simple-node.male {
            border-left: 4px solid #1976d2;
            background: #f8fbff;
        }

        .simple-node.female {
            border-left: 4px solid #c2185b;
            background: #fff8fb;
        }

        .simple-node:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

    /* تخصيص للشكل الهرمي - من الكود الثاني */
    .pyramid-container {
        position: relative;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        padding: 20px;
    }

    .generation-label {
        position: absolute;
        left: 10px;
        background: rgba(0,0,0,0.1);
        padding: 5px 10px;
        border-radius: 5px;
        font-size: 12px;
        font-weight: bold;
    }

    /* عناصر مشتركة */
    .children-container {
        position: relative;
        margin-top: 60px;
    }

    .generation-line {
        position: absolute;
        height: 2px;
        background: #999;
        top: -30px;
        z-index: 1;
    }

    #tree-container {
        cursor: grab;
    }

        #tree-container:active {
            cursor: grabbing;
        }

    .loading-spinner {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
    }

    /* إضافة كلاس للإخفاء أثناء الطباعة */
    .no-print {
        display: block;
    }

    .pdf-loading {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
        z-index: 9999;
        display: none;
        justify-content: center;
        align-items: center;
        color: white;
        font-size: 18px;
    }

    /* ستايلات خاصة للطباعة */
    .print-version {
        background: white !important;
        padding: 20px !important;
    }

    .print-hierarchical {
        min-width: 2000px !important;
        min-height: 1000px !important;
        padding: 50px !important;
    }

    .print-leaf {
        background: linear-gradient(135deg, #e8f5e8, #c8e6c9) !important;
        border-radius: 20px !important;
        padding: 30px !important;
    }

    .print-simple {
        background: linear-gradient(135deg, #f5f5f5, #e0e0e0) !important;
        padding: 20px !important;
    }

    /* إشعارات */
    .alert-notification {
        position: fixed !important;
        top: 20px !important;
        right: 20px !important;
        z-index: 9999 !important;
        min-width: 300px !important;
        animation: slideInRight 0.5s ease-out !important;
    }

    /* تأثيرات إضافية */
    .fade-in {
        animation: fadeInUp 0.5s ease-out;
    }

    .bounce-in {
        animation: bounceIn 0.6s ease-out;
    }

    .slide-in {
        animation: slideInRight 0.5s ease-out;
    }

    .pulse-effect {
        animation: pulse 2s infinite;
    }

    /* تحسينات للطباعة عالية الجودة */
    .high-quality-print {
        -webkit-print-color-adjust: exact !important;
        color-adjust: exact !important;
        print-color-adjust: exact !important;
    }

    .print-optimized {
        image-rendering: -webkit-optimize-contrast !important;
        image-rendering: crisp-edges !important;
    }
</style>

<!-- مكتبات إضافية للPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

@section Scripts {
    <script>
        // بيانات الشجرة من ViewBag
        const personsJson = '@Html.Raw(ViewBag.PersonsJson)' || '[]';
        const familyTreeId = @ViewBag.FamilyTreeId;
        const familyTreeName = '@familyTreeName';
        const personsCount = @personsCount;

        console.log('عدد الأفراد:', personsCount);
        console.log('بيانات JSON:', personsJson);
        console.log('اسم الشجرة:', familyTreeName);

        let treeData = [];
        let zoomLevel = 1.0;
        let panning = false;
        let startX, startY, scrollLeft, scrollTop;
        let allConnectors = [];
        let currentCardStyle = 'default';
        let currentLayout = 'hierarchical';

        // ========== دوال جديدة من الكود الثاني ==========

        function initializeSVG() {
            const svg = $('#connections-svg');
            svg.empty();

            const defs = $(`
                <defs>
                    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                        <polygon points="0 0, 10 3.5, 0 7" fill="#666"/>
                    </marker>
                    <marker id="arrowhead-male" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                        <polygon points="0 0, 10 3.5, 0 7" fill="#1976d2"/>
                    </marker>
                    <marker id="arrowhead-female" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                        <polygon points="0 0, 10 3.5, 0 7" fill="#c2185b"/>
                    </marker>
                </defs>
            `);
            svg.append(defs);
        }

        function organizeByGenerations(persons) {
            const generations = [];

            // إيجاد الجيل الأول (الأجداد بدون آباء)
            const firstGen = persons.filter(person => !person.fatherId);
            generations.push(firstGen);

            let currentGen = firstGen;
            let generationNumber = 1;

            while (currentGen.length > 0) {
                const nextGen = [];
                currentGen.forEach(person => {
                    const children = persons.filter(p => p.fatherId === person.id);
                    nextGen.push(...children);
                });

                if (nextGen.length > 0) {
                    generations.push(nextGen);
                }
                currentGen = nextGen;
                generationNumber++;
            }
            return generations;
        }

        function drawConnections() {
            const svg = $('#connections-svg');
            svg.find('path').remove();

            treeData.forEach(person => {
                if (person.fatherId) {
                    const father = treeData.find(p => p.id === person.fatherId);
                    if (father) {
                        drawConnection(father, person);
                    }
                }
            });
        }

        function drawConnection(fromPerson, toPerson) {
            const fromElement = $(`[data-person-id="${fromPerson.id}"]`);
            const toElement = $(`[data-person-id="${toPerson.id}"]`);

            if (fromElement.length === 0 || toElement.length === 0) return;

            const fromRect = fromElement[0].getBoundingClientRect();
            const toRect = toElement[0].getBoundingClientRect();
            const container = $('#family-tree')[0].getBoundingClientRect();

            const fromX = fromRect.left - container.left + fromRect.width / 2;
            const fromY = fromRect.bottom - container.top;
            const toX = toRect.left - container.left + toRect.width / 2;
            const toY = toRect.top - container.top;

            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            const gender = toPerson.gender || 'Male';
            const arrowhead = gender === 'Male' ? 'url(#arrowhead-male)' : 'url(#arrowhead-female)';

            // مسار منحني للشكل الهرمي
            const controlY = fromY + (toY - fromY) / 2;
            const pathData = `
                M ${fromX} ${fromY}
                C ${fromX} ${controlY}, ${toX} ${controlY}, ${toX} ${toY}
            `;

            path.setAttribute('d', pathData);
            path.setAttribute('class', `connection-line ${gender}`);
            path.setAttribute('marker-end', arrowhead);
            path.setAttribute('stroke-dasharray', '1000');
            path.setAttribute('stroke-dashoffset', '1000');

            $('#connections-svg').append(path);

            // أنيميشن رسم الخط
            setTimeout(() => {
                path.style.animation = 'drawLine 1.5s ease-out forwards';
            }, 100);
        }

        function drawPyramidTree() {
            const container = $('#family-tree');
            container.empty();

            if (treeData.length === 0) {
                container.html('<div class="alert alert-warning text-center">لا توجد بيانات لعرضها</div>');
                return;
            }

            const generations = organizeByGenerations(treeData);
            console.log('الأجيال:', generations);

            const containerWidth = 2000;
            const startY = 50;
            const verticalSpacing = 150;

            // إضافة تسمية للشكل الهرمي
            container.append(`
                <div style="position: absolute; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.1); padding: 10px 20px; border-radius: 10px; font-weight: bold;">
                    🏛️ الشكل الهرمي للشجرة العائلية
                </div>
            `);

            generations.forEach((generation, genIndex) => {
                const generationY = startY + (genIndex * verticalSpacing);
                const generationSize = generation.length;
                const maxGenerationSize = Math.max(...generations.map(gen => gen.length));

                // حساب المسافة الأفقية بناءً على حجم الجيل
                const horizontalSpacing = Math.min(300, (containerWidth - 200) / Math.max(1, generationSize));
                const totalWidth = generationSize * horizontalSpacing;
                const startX = (containerWidth - totalWidth) / 2;

                // إضافة تسمية الجيل
                container.append(`
                    <div class="generation-label" style="top: ${generationY - 30}px;">
                        الجيل ${genIndex + 1}
                    </div>
                `);

                generation.forEach((person, personIndex) => {
                    const personX = startX + (personIndex * horizontalSpacing);
                    createPersonNode(person, personX, generationY, container);
                });
            });

            setTimeout(drawConnections, 200);
        }

        function createPersonNode(person, x, y, container) {
            const birthDate = formatDate(person.birthDate);
            const city = person.city || '';
            const occupationName = person.occupationName || '';
            const gender = person.gender || 'Male';

            const styleClass = currentCardStyle !== 'default' ? ` ${currentCardStyle}` : '';

            const nodeContent = `
                <div class="tree-node ${gender === 'Male' ? 'male' : 'female'}${styleClass}"
                     data-person-id="${person.id}"
                     style="left: ${x}px; top: ${y}px;">
                    <div class="node-name">${escapeHtml(person.fullName || 'غير معروف')}</div>
                    <div class="node-details">
                        ${birthDate ? '📅 ' + birthDate + '<br>' : ''}
                        ${city ? '🏠 ' + escapeHtml(city) + '<br>' : ''}
                        ${occupationName ? '💼 ' + escapeHtml(occupationName) : ''}
                    </div>
                </div>
            `;

            const node = $(nodeContent);

            node.on('click', function(e) {
                e.stopPropagation();
                showPersonDetails(person);
            });

            container.append(node);
        }

        // ========== دوال موجودة مسبقاً ==========

        function formatDate(dateString) {
            try {
                if (!dateString) return '';
                const date = new Date(dateString);
                return isNaN(date.getTime()) ? dateString : date.toLocaleDateString('ar-EG');
            } catch (e) {
                return dateString;
            }
        }

        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe
                .toString()
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function loadTreeData() {
            try {
                if (personsJson && personsJson !== '[]') {
                    treeData = JSON.parse(personsJson);
                    console.log('تم تحليل البيانات بنجاح:', treeData.length, 'فرد');
                    return true;
                }
                return false;
            } catch (e) {
                console.error('خطأ في تحليل JSON:', e);
                return false;
            }
        }

        function changeCardStyle(style) {
            currentCardStyle = style;
            console.log('تغيير شكل البطاقة إلى:', style);
            redrawCurrentLayout();
            showNotification(`تم تغيير الشكل إلى: ${getStyleName(style)}`, 'success');
        }

        function changeLayout(layout) {
            currentLayout = layout;
            console.log('تغيير شكل العرض إلى:', layout);
            redrawCurrentLayout();
            showNotification(`تم تغيير العرض إلى: ${getLayoutName(layout)}`, 'success');
        }

        function redrawCurrentLayout() {
            const container = $('#family-tree');
            container.empty();
            $('#connections-svg').empty();

            container.removeClass('leaf-layout simple-layout pyramid-container');

            if (currentLayout === 'leaf') {
                container.addClass('leaf-layout');
                drawLeafLayout();
            } else if (currentLayout === 'simple') {
                container.addClass('simple-layout');
                drawSimpleLayout();
            } else {
                container.addClass('pyramid-container');
                initializeSVG();
                drawPyramidTree();
            }
        }

        function getStyleName(style) {
            const styles = {
                'default': 'الشكل الافتراضي',
                'modern': 'الشكل الحديث',
                'elegant': 'الشكل الأنيق',
                'minimal': 'الشكل البسيط',
                'colorful': 'الشكل الملون'
            };
            return styles[style] || 'غير معروف';
        }

        function getLayoutName(layout) {
            const layouts = {
                'hierarchical': 'الشكل الهرمي',
                'leaf': 'شكل ورقة الشجرة',
                'simple': 'الشكل المبسط'
            };
            return layouts[layout] || 'غير معروف';
        }

        function drawLeafLayout() {
            const container = $('#family-tree');
            console.log('رسم شكل ورقة الشجرة');

            const generations = organizeByGeneration();
            console.log('عدد الأجيال:', generations.length);

            if (generations.length === 0) {
                container.html('<div class="alert alert-warning text-center">لا توجد بيانات لعرضها</div>');
                return;
            }

            generations.forEach((generation, genIndex) => {
                const generationDiv = $(`<div class="leaf-generation"></div>`);
                const title = $(`<div class="generation-title">الجيل ${genIndex + 1}</div>`);
                generationDiv.append(title);

                console.log(`الجيل ${genIndex + 1}:`, generation.length, 'فرد');

                generation.forEach((person) => {
                    const node = createLeafNode(person);
                    generationDiv.append(node);
                });

                container.append(generationDiv);
            });

            container.append('<div style="height: 50px;"></div>');
        }

        function drawSimpleLayout() {
            const container = $('#family-tree');
            console.log('رسم الشكل المبسط');

            treeData.forEach((person) => {
                const node = createSimpleNode(person);
                container.append(node);
            });
        }

        function createLeafNode(person) {
            const birthDate = formatDate(person.birthDate);
            const city = person.city || '';
            const occupationName = person.occupationName || '';
            const gender = person.gender || 'Male';

            const nodeContent = `
                <div class="leaf-node ${gender === 'Male' ? 'male' : 'female'}"
                     data-person-id="${person.id}">
                    <div class="node-name">${escapeHtml(person.fullName || 'غير معروف')}</div>
                    <div class="node-details">
                        ${birthDate ? '📅 ' + birthDate + '<br>' : ''}
                        ${city ? '🏠 ' + escapeHtml(city) + '<br>' : ''}
                        ${occupationName ? '💼 ' + escapeHtml(occupationName) : ''}
                    </div>
                </div>
            `;

            const node = $(nodeContent);

            node.on('click', function(e) {
                e.stopPropagation();
                showPersonDetails(person);
            });

            return node;
        }

        function createSimpleNode(person) {
            const birthDate = formatDate(person.birthDate);
            const gender = person.gender || 'Male';

            const nodeContent = `
                <div class="simple-node ${gender === 'Male' ? 'male' : 'female'}"
                     data-person-id="${person.id}">
                    <div class="node-name">${escapeHtml(person.fullName || 'غير معروف')}</div>
                    <div class="node-details">
                        ${birthDate ? '📅 ' + birthDate : ''}
                    </div>
                </div>
            `;

            const node = $(nodeContent);

            node.on('click', function(e) {
                e.stopPropagation();
                showPersonDetails(person);
            });

            return node;
        }

        function organizeByGeneration() {
            const generations = [];
            const processed = new Set();

            const roots = treeData.filter(p => !p.fatherId);
            console.log('عدد الأجداد:', roots.length);

            if (roots.length > 0) {
                generations.push(roots);
                roots.forEach(root => processed.add(root.id));

                let currentGen = roots;
                let generationNumber = 1;

                while (currentGen.length > 0) {
                    const nextGen = [];
                    currentGen.forEach(parent => {
                        const children = treeData.filter(p => p.fatherId === parent.id && !processed.has(p.id));
                        children.forEach(child => {
                            nextGen.push(child);
                            processed.add(child.id);
                        });
                    });

                    if (nextGen.length > 0) {
                        generations.push(nextGen);
                        console.log(`الجيل ${generationNumber + 1}:`, nextGen.length, 'فرد');
                    }
                    currentGen = nextGen;
                    generationNumber++;
                }
            } else {
                generations.push(treeData);
            }

            const unprocessed = treeData.filter(p => !processed.has(p.id));
            if (unprocessed.length > 0) {
                console.log('أشخاص غير معالجين:', unprocessed.length);
                generations.push(unprocessed);
            }

            return generations;
        }

        function showPersonDetails(person) {
            const birthDate = formatDate(person.birthDate);
            const city = person.city || '';
            const occupationName = person.occupationName || '';

            let details = '';
            if (birthDate) details += `الميلاد: ${birthDate}<br>`;
            if (city) details += `المدينة: ${escapeHtml(city)}<br>`;
            if (occupationName) details += `المهنة: ${escapeHtml(occupationName)}<br>`;
            if (!details) details = 'لا توجد معلومات إضافية';

            const infoContent = `
                <div class="card-body">
                    <h5>${escapeHtml(person.fullName || 'غير معروف')}</h5>
                    <p>${details}</p>
                    <div class="mt-2">
                        <a href="/Person/Details/${person.id}" class="btn btn-info btn-sm">
                            <i class="fas fa-eye"></i> تفاصيل
                        </a>
                        <a href="/Person/Edit/${person.id}" class="btn btn-warning btn-sm">
                            <i class="fas fa-edit"></i> تعديل
                        </a>
                        <a href="/Person/Create?familyTreeId=${familyTreeId}&fatherId=${person.id}" class="btn btn-success btn-sm">
                            <i class="fas fa-plus"></i> إضافة ابن
                        </a>
                    </div>
                </div>
            `;

            $('#node-info').html(infoContent).show();
        }

        function printToPdf() {
            showPdfLoading(true);
            showNotification('جاري إنشاء PDF عالي الجودة...', 'info');

            setTimeout(() => {
                try {
                    const originalTree = $('#family-tree').clone();
                    const originalSVG = $('#connections-svg').clone();

                    originalTree.addClass('print-version high-quality-print print-optimized');
                    if (currentLayout === 'hierarchical') {
                        originalTree.addClass('print-hierarchical');
                    } else if (currentLayout === 'leaf') {
                        originalTree.addClass('print-leaf');
                    } else if (currentLayout === 'simple') {
                        originalTree.addClass('print-simple');
                    }

                    originalTree.find('*').css({
                        'transform': 'none',
                        'transition': 'none',
                        'animation': 'none',
                        'box-shadow': '0 2px 8px rgba(0,0,0,0.2)',
                        'border': '1px solid #ccc'
                    });

                    const printContainer = $('<div style="background: white; position: absolute; left: 0; top: 0; z-index: 99999; width: 100%;"></div>');

                    const title = $(`
                        <div style="text-align: center; padding: 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; margin-bottom: 20px;">
                            <h1 style="margin: 0; font-size: 32px; font-weight: bold;">الشجرة العائلية</h1>
                            <h2 style="margin: 10px 0; font-size: 24px;">${familyTreeName}</h2>
                            <div style="display: flex; justify-content: center; gap: 20px; margin-top: 15px; font-size: 14px;">
                                <span>📅 تم الإنشاء في: ${new Date().toLocaleDateString('ar-EG')}</span>
                                <span>👥 عدد الأفراد: ${personsCount}</span>
                                <span>🎨 شكل العرض: ${getLayoutName(currentLayout)}</span>
                                <span>💎 شكل البطاقة: ${getStyleName(currentCardStyle)}</span>
                            </div>
                        </div>
                    `);
                    printContainer.append(title);
                    printContainer.append(originalTree);
                    printContainer.append(originalSVG);

                    const tempContainer = $('<div style="position: fixed; left: 0; top: 0; width: 100%; height: 100%; background: white; z-index: 99998; overflow: auto;"></div>');
                    tempContainer.append(printContainer);
                    $('body').append(tempContainer);

                    const options = {
                        scale: 3,
                        useCORS: true,
                        backgroundColor: '#ffffff',
                        logging: false,
                        width: printContainer[0].scrollWidth,
                        height: printContainer[0].scrollHeight,
                        scrollX: 0,
                        scrollY: 0,
                        onclone: function(clonedDoc) {
                            const clonedContainer = clonedDoc.querySelector('.print-version');
                            if (clonedContainer) {
                                clonedContainer.style.transform = 'none';
                                clonedContainer.style.overflow = 'visible';
                            }
                        }
                    };

                    html2canvas(printContainer[0], options).then(canvas => {
                        tempContainer.remove();

                        const highQualityCanvas = document.createElement('canvas');
                        highQualityCanvas.width = canvas.width;
                        highQualityCanvas.height = canvas.height;
                        const ctx = highQualityCanvas.getContext('2d');

                        ctx.imageSmoothingEnabled = true;
                        ctx.imageSmoothingQuality = 'high';
                        ctx.drawImage(canvas, 0, 0);

                        const imgData = highQualityCanvas.toDataURL('image/png', 1.0);

                        const pdf = new jspdf.jsPDF({
                            orientation: canvas.width > canvas.height ? 'landscape' : 'portrait',
                            unit: 'mm',
                            format: 'a4',
                            compress: true
                        });

                        const pdfWidth = pdf.internal.pageSize.getWidth();
                        const pdfHeight = pdf.internal.pageSize.getHeight();

                        const imgWidth = canvas.width;
                        const imgHeight = canvas.height;

                        const ratio = Math.min(pdfWidth / imgWidth, pdfHeight / imgHeight) * 0.95;
                        const finalWidth = imgWidth * ratio;
                        const finalHeight = imgHeight * ratio;

                        pdf.addImage(imgData, 'PNG',
                            (pdfWidth - finalWidth) / 2,
                            (pdfHeight - finalHeight) / 2,
                            finalWidth,
                            finalHeight,
                            undefined,
                            'FAST'
                        );

                        pdf.setFontSize(10);
                        pdf.setTextColor(100);
                        pdf.text(`تم الإنشاء في: ${new Date().toLocaleDateString('ar-EG')}`, 10, pdfHeight - 15);
                        pdf.text(`عدد الأفراد: ${personsCount} | الشكل: ${getLayoutName(currentLayout)}`, 10, pdfHeight - 10);

                        const fileName = `شجرة_عائلية_${familyTreeName.replace(/\s+/g, '_')}.pdf`;
                        pdf.save(fileName);

                        showPdfLoading(false);
                        showNotification('تم إنشاء PDF عالي الجودة بنجاح', 'success');

                    }).catch(error => {
                        console.error('خطأ في إنشاء PDF:', error);
                        tempContainer.remove();
                        showPdfLoading(false);
                        showNotification('حدث خطأ في إنشاء PDF', 'danger');
                    });

                } catch (error) {
                    console.error('خطأ عام:', error);
                    showPdfLoading(false);
                    showNotification('حدث خطأ غير متوقع', 'danger');
                }
            }, 1000);
        }

        function showPdfLoading(show) {
            let loadingDiv = $('#pdf-loading');

            if (show) {
                if (loadingDiv.length === 0) {
                    loadingDiv = $(`
                        <div id="pdf-loading" class="pdf-loading">
                            <div class="text-center">
                                <div class="spinner-border text-light mb-3" role="status">
                                    <span class="sr-only">جاري التحميل...</span>
                                </div>
                                <div>جاري إنشاء PDF عالي الجودة...</div>
                                <small>قد يستغرق هذا بضع ثوانٍ</small>
                            </div>
                        </div>
                    `);
                    $('body').append(loadingDiv);
                }
                loadingDiv.show();
            } else {
                loadingDiv.hide();
            }
        }

        function showNotification(message, type = 'info') {
            $('.alert-notification').remove();

            const alertClass = {
                'info': 'alert-info',
                'success': 'alert-success',
                'danger': 'alert-danger',
                'warning': 'alert-warning'
            }[type] || 'alert-info';

            const icon = {
                'info': 'fa-info-circle',
                'success': 'fa-check-circle',
                'danger': 'fa-exclamation-circle',
                'warning': 'fa-exclamation-triangle'
            }[type];

            const notification = $(`
                <div class="alert ${alertClass} alert-dismissible fade show position-fixed alert-notification"
                     style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
                    <div class="d-flex align-items-center">
                        <i class="fas ${icon} me-2"></i>
                        <div>${message}</div>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `);

            $('body').append(notification);

            setTimeout(() => {
                notification.alert('close');
            }, 5000);
        }

        function initializeTree() {
            const container = $('#family-tree');
            container.empty().html(`
                <div class="loading-spinner">
                    <div class="spinner-border text-primary" role="status">
                        <span class="sr-only">جاري التحميل...</span>
                    </div>
                    <p class="mt-2">جاري تحميل الشجرة العائلية...</p>
                </div>
            `);

            setTimeout(() => {
                if (treeData.length > 0) {
                    redrawCurrentLayout();
                    $('.loading-spinner').remove();
                }
            }, 100);
        }

        function setupZoomAndPan() {
            const container = $('#tree-container');
            const tree = $('#family-tree');

            $('#zoomIn').on('click', function() {
                zoomLevel = Math.min(zoomLevel + 0.1, 2.0);
                tree.css('transform', `scale(${zoomLevel})`);
            });

            $('#zoomOut').on('click', function() {
                zoomLevel = Math.max(zoomLevel - 0.1, 0.3);
                tree.css('transform', `scale(${zoomLevel})`);
            });

            $('#resetView').on('click', function() {
                zoomLevel = 1.0;
                tree.css('transform', 'scale(1)');
                container.scrollLeft(0);
                container.scrollTop(0);
            });

            container.on('mousedown', function(e) {
                if ($(e.target).closest('.tree-node, .leaf-node, .simple-node').length === 0) {
                    panning = true;
                    startX = e.pageX - container.offset().left;
                    startY = e.pageY - container.offset().top;
                    scrollLeft = container.scrollLeft();
                    scrollTop = container.scrollTop();
                    container.css('cursor', 'grabbing');
                }
            });

            $(document).on('mouseup', function() {
                panning = false;
                container.css('cursor', 'grab');
            });

            container.on('mousemove', function(e) {
                if (!panning) return;
                e.preventDefault();
                const x = e.pageX - container.offset().left;
                const y = e.pageY - container.offset().top;
                const walkX = (x - startX) * 2;
                const walkY = (y - startY) * 2;
                container.scrollLeft(scrollLeft - walkX);
                container.scrollTop(scrollTop - walkY);
            });

            $('#printPdf').on('click', printToPdf);

            $('.card-style').on('click', function(e) {
                e.preventDefault();
                changeCardStyle($(this).data('style'));
            });

            $('.layout-style').on('click', function(e) {
                e.preventDefault();
                changeLayout($(this).data('layout'));
            });
        }

        $(document).ready(function () {
            console.log('بدء التهيئة...');

            if (loadTreeData()) {
                initializeTree();
                setupZoomAndPan();
            } else {
                $('#family-tree').html(`
                    <div class="alert alert-danger text-center" style="margin: 50px;">
                        <h4>❌ خطأ في تحميل البيانات</h4>
                        <p>حدث خطأ أثناء تحميل بيانات الشجرة العائلية.</p>
                        <button onclick="location.reload()" class="btn btn-primary">
                            <i class="fas fa-redo"></i> إعادة تحميل
                        </button>
                    </div>
                `);
            }

            $(document).on('click', function(e) {
                if (!$(e.target).closest('#node-info, .tree-node, .leaf-node, .simple-node').length) {
                    $('#node-info').hide();
                }
            });
        });
    </script>
}