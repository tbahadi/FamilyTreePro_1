@{
    ViewData["Title"] = "إحصائيات النظام";
}

<style>
    .card {
        transition: transform 0.3s ease;
        border: none;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

        .card:hover {
            transform: translateY(-5px);
        }

    .card-body h3 {
        font-size: 2.5rem;
        font-weight: bold;
    }

    .stat-card {
        text-align: center;
        padding: 20px;
        border-radius: 10px;
        color: white;
        margin-bottom: 20px;
    }

    .table th {
        background-color: #2c3e50;
        color: white;
        text-align: center;
    }
</style>

<div class="container">
    <div class="row">
        <div class="col-12">
            <h1 class="text-center mb-4">📊 إحصائيات النظام</h1>
        </div>
    </div>

    <!-- بطاقات الإحصائيات الرئيسية -->
    <div class="row">
        <!-- المستخدمين -->
        <div class="col-md-3 mb-4">
            <div class="card text-center bg-primary text-white">
                <div class="card-body">
                    <i class="fas fa-users fa-3x mb-3"></i>
                    <h3>@ViewBag.TotalUsers</h3>
                    <h5>إجمالي المستخدمين</h5>
                </div>
            </div>
        </div>

        <!-- المستخدمين النشطين -->
        <div class="col-md-3 mb-4">
            <div class="card text-center bg-success text-white">
                <div class="card-body">
                    <i class="fas fa-user-check fa-3x mb-3"></i>
                    <h3>@ViewBag.ActiveUsers</h3>
                    <h5>مستخدمين نشطين</h5>
                </div>
            </div>
        </div>

        <!-- مدراء النظام -->
        <div class="col-md-3 mb-4">
            <div class="card text-center bg-warning text-dark">
                <div class="card-body">
                    <i class="fas fa-crown fa-3x mb-3"></i>
                    <h3>@ViewBag.AdminUsers</h3>
                    <h5>مدير نظام</h5>
                </div>
            </div>
        </div>

        <!-- تسجيلات حديثة -->
        <div class="col-md-3 mb-4">
            <div class="card text-center bg-info text-white">
                <div class="card-body">
                    <i class="fas fa-chart-line fa-3x mb-3"></i>
                    <h3>@ViewBag.RecentRegistrations</h3>
                    <h5>تسجيلات هذا الأسبوع</h5>
                </div>
            </div>
        </div>
    </div>

    <!-- إحصائيات إضافية -->
    <div class="row">
        <!-- الشجرات العائلية -->
        <div class="col-md-4 mb-4">
            <div class="card text-center bg-secondary text-white">
                <div class="card-body">
                    <i class="fas fa-tree fa-3x mb-3"></i>
                    <h3>@ViewBag.TotalTrees</h3>
                    <h5>شجرة عائلية</h5>
                </div>
            </div>
        </div>

        <!-- الأفراد -->
        <div class="col-md-4 mb-4">
            <div class="card text-center bg-dark text-white">
                <div class="card-body">
                    <i class="fas fa-user-friends fa-3x mb-3"></i>
                    <h3>@ViewBag.TotalPersons</h3>
                    <h5>فرد في النظام</h5>
                </div>
            </div>
        </div>

        <!-- نسبة النشاط -->
        <div class="col-md-4 mb-4">
            <div class="card text-center bg-light">
                <div class="card-body">
                    <i class="fas fa-percentage fa-3x mb-3 text-primary"></i>
                    <h3>
                        @{
                            var activityRate = ViewBag.ActiveUsers * 100 / Math.Max(ViewBag.TotalUsers, 1);
                            @activityRate
                        }
%
                    </h3>
                    <h5 class="text-dark">نسبة النشاط</h5>
                </div>
            </div>
        </div>
    </div>

    <!-- إحصائيات المستخدمين التفصيلية -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h4 class="mb-0"><i class="fas fa-chart-pie me-2"></i>إحصائيات المستخدمين التفصيلية</h4>
                </div>
                <div class="card-body">
                    @if (ViewBag.UsersWithStats != null && ViewBag.UsersWithStats.Count > 0)
                    {
                        <div class="table-responsive">
                            <table class="table table-striped table-bordered">
                                <thead class="table-dark">
                                    <tr>
                                        <th>اسم المستخدم</th>
                                        <th>الحالة</th>
                                        <th>عدد الشجرات</th>
                                        <th>إجمالي الأفراد</th>
                                        <th>متوسط الأفراد لكل شجرة</th>
                                        <th>تاريخ التسجيل</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var userStat in ViewBag.UsersWithStats)
                                    {
                                        <tr>
                                            <td>
                                                <strong>@userStat.User.Username</strong>
                                                @if (userStat.User.IsAdmin)
                                                {
                                                    <span class="badge bg-warning text-dark ms-1">👑 مدير</span>
                                                }
                                            </td>
                                            <td>
                                                @if (userStat.User.IsActive)
                                                {
                                                    <span class="badge bg-success">نشط</span>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-danger">معطل</span>
                                                }
                                            </td>
                                            <td>
                                                <span class="badge bg-primary fs-6">@userStat.TreeCount 🌳</span>
                                            </td>
                                            <td>
                                                <span class="badge bg-info fs-6">@userStat.PersonCount 👥</span>
                                            </td>
                                            <td>
                                                @{
                                                    var avgPersons = userStat.TreeCount > 0 ?
                                                    (userStat.PersonCount / userStat.TreeCount) : 0;
                                                }
                                                <span class="badge bg-secondary fs-6">@avgPersons ⚡</span>
                                            </td>
                                            <td>@userStat.User.CreatedDate.ToString("yyyy/MM/dd")</td>
                                        </tr>
                                    }
                                </tbody>
                                <tfoot class="table-light">
                                    <tr>
                                        <td><strong>المجموع</strong></td>
                                        <td></td>
                                        <td><strong class="text-primary">@ViewBag.TotalTrees 🌳</strong></td>
                                        <td><strong class="text-info">@ViewBag.TotalPersons 👥</strong></td>
                                        <td>
                                            @{
                                                var totalAvg = ViewBag.TotalTrees > 0 ?
                                                (ViewBag.TotalPersons / ViewBag.TotalTrees) : 0;
                                            }
                                            <strong class="text-secondary">@totalAvg ⚡</strong>
                                        </td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    }
                    else
                    {
                        <p class="text-center text-muted">
                            <i class="fas fa-users fa-2x mb-3"></i><br>
                            لا توجد بيانات للمستخدمين
                        </p>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- أحدث المستخدمين -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0"><i class="fas fa-clock me-2"></i>أحدث المستخدمين</h4>
                </div>
                <div class="card-body">
                    @if (ViewBag.LatestUsers != null && ViewBag.LatestUsers.Count > 0)
                    {
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>اسم المستخدم</th>
                                        <th>الاسم الكامل</th>
                                        <th>البريد الإلكتروني</th>
                                        <th>تاريخ التسجيل</th>
                                        <th>الحالة</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var user in ViewBag.LatestUsers)
                                    {
                                        <tr>
                                            <td>@user.Username</td>
                                            <td>@user.FullName</td>
                                            <td>@user.Email</td>
                                            <td>@user.CreatedDate.ToString("yyyy/MM/dd")</td>
                                            <td>
                                                @if (user.IsActive)
                                                {
                                                    <span class="badge bg-success">نشط</span>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-danger">معطل</span>
                                                }
                                                @if (user.IsAdmin)
                                                {
                                                    <span class="badge bg-warning text-dark">مدير</span>
                                                }
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <p class="text-center text-muted">لا يوجد مستخدمين</p>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- أزرار التنقل -->
    <div class="row mt-4">
        <div class="col-12 text-center">
            <a asp-action="Users" class="btn btn-primary me-2">
                <i class="fas fa-users me-1"></i>إدارة المستخدمين
            </a>
            <a asp-action="Index" asp-controller="Home" class="btn btn-secondary">
                <i class="fas fa-home me-1"></i>الرئيسية
            </a>
        </div>
    </div>
</div>